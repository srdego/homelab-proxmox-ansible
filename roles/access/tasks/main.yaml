# Enforce SSH key-based access policy

- name: Verify that the configured SSH public key exists on control node
  delegate_to: localhost
  run_once: true
  ansible.builtin.stat:
    path: "{{ ssh_pub_key_path }}"
  register: access_local_key_file
  failed_when: not access_local_key_file.stat.exists
  tags:
    - access
    - ssh_hardening

- name: Install authorized SSH keys
  ansible.posix.authorized_key:
    user: "{{ item.user }}"
    key: "{{ lookup('file', item.key) }}"
    manage_dir: true
    state: present
  loop: "{{ ssh_authorized_accounts }}"
  loop_control:
    label: "{{ item.user }}"
  tags:
    - access
    - ssh_hardening

- name: Apply hardened sshd directives
  ansible.builtin.lineinfile:
    path: "{{ sshd_config_path }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: "/usr/sbin/sshd -t -f %s" # prevents bad configs from being saved
  loop: "{{ sshd_directives }}"
  loop_control:
    label: "{{ item.line }}"
  notify: Restart sshd
  tags:
    - access
    - ssh_hardening
